<!-- Substitua TODO o <script> no final do seu HTML pelo código abaixo -->
<script>
  function verificarCampos() {
    const vaga = document.getElementById("vaga").value.trim();
    const curriculo = document.getElementById("curriculo").value.trim();
    document.getElementById("botao-analisar").classList.toggle("hidden", !vaga || !curriculo);
    document.getElementById("botao-relatorio").classList.toggle("hidden", !vaga || !curriculo);
  }

  async function analisarCurriculo() {
    const curriculo = document.getElementById("curriculo").value;
    const cargoAtual = document.getElementById("cargoAtual").value;
    const vaga = document.getElementById("vaga").value;

    try {
      const resposta = await fetch('https://dbdb8de5-5b50-41c7-87fc-61820d3ac31c-00-2g4kx1dp3sp2n.worf.replit.dev/analise', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ curriculo, cargoAtual, vaga })
      });

      const dados = await resposta.json();

      // Atualiza resultado na interface
      document.getElementById("resultado").innerText = dados.resultado || "Erro ao analisar.";
      document.getElementById("sugestoes").innerText = dados.sugestoes || "";

      // Destaca palavras no currículo
      const palavras = dados.palavrasDetectadas || [];
      let curriculoComDestaque = curriculo;
      palavras.forEach(palavra => {
        const regex = new RegExp(`(${palavra})`, 'gi');
        curriculoComDestaque = curriculoComDestaque.replace(regex, '**$1**');
      });
      document.getElementById("destacado").innerText = curriculoComDestaque;

      // Adiciona ao histórico
      adicionarAoHistorico(dados.resultado);
    } catch (erro) {
      document.getElementById("resultado").innerText = "Erro ao conectar com o servidor: " + erro.message;
    }
  }

  function adicionarAoHistorico(texto) {
    const item = document.createElement("li");
    item.textContent = texto;
    document.getElementById("historicoLista").appendChild(item);
  }

  function baixarRelatorio() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const resultado = document.getElementById("resultado").innerText;
    const sugestoes = document.getElementById("sugestoes").innerText;

    doc.setFont("courier", "normal");
    doc.setFontSize(12);
    doc.text("Relatório de Análise de Currículo", 10, 10);
    doc.setFontSize(10);
    doc.text("Resultado:", 10, 20);
    doc.text(resultado, 10, 30);
    doc.text("\nSugestões:", 10, 90);
    doc.text(sugestoes, 10, 100);

    doc.save("relatorio_analise_curriculo.pdf");
  }

  function baixarHistoricoCSV() {
    const itens = [...document.querySelectorAll("#historicoLista li")].map(li => li.textContent);
    const csv = "Histórico\n" + itens.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "historico_analises.csv");
    link.click();
  }

  function limparVagas() {
    document.getElementById("lista-vagas").innerHTML = "";
  }

  function toggleDarkMode() {
    const body = document.getElementById("body");
    body.classList.toggle("bg-gray-900");
    body.classList.toggle("text-white");
  }

  document.getElementById("vaga").addEventListener("input", verificarCampos);
  document.getElementById("curriculo").addEventListener("input", verificarCampos);
  document.getElementById("botao-analisar").addEventListener("click", analisarCurriculo);
  document.getElementById("botao-relatorio").addEventListener("click", baixarRelatorio);
</script>
